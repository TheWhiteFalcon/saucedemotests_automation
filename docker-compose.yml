version: '3.8'

services:
  # Ð¡ÐµÑ€Ð²Ð¸Ñ Ñ Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸
  tests:
    build: .
    container_name: sauce-demo-tests
    volumes:
      # ÐœÐ¾Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Allure
      - ./allure-results:/app/allure-results
      # ÐœÐ¾Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°
      - ./reports:/app/reports
    depends_on:
      - selenium
    environment:
      - SELENIUM_HOST=selenium
    # ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²
    command: >
      sh -c "
      echo 'â³ ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐº Selenium...' &&
      sleep 5 &&
      echo 'ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹...' &&
      python -m pytest src/tests/ -v --alluredir=/app/allure-results --html=/app/reports/report.html
      "
    # ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑÑ

  # Selenium Chrome ÑÐµÑ€Ð²ÐµÑ€
  selenium:
    image: selenium/standalone-chrome:4.18
    container_name: selenium-chrome
    ports:
      - "4444:4444"
    shm_size: 2gb
    # Headless Ñ€ÐµÐ¶Ð¸Ð¼ (Ð±ÐµÐ· Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°)
    environment:
      - SE_SCREEN_WIDTH=1920
      - SE_SCREEN_HEIGHT=1080
      - SE_START_XVFB=false

  # Ð¡ÐµÑ€Ð²ÐµÑ€ Allure-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð²
  allure:
    image: frankescobar/allure-docker-service
    container_name: allure-server
    depends_on:
      - tests  # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
    ports:
      - "5050:5050"  # Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Allure
    environment:
      CHECK_RESULTS_EVERY_SECONDS: 3
      KEEP_HISTORY: "true"
    volumes:
      # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ñƒ Ð¶Ðµ Ð¿Ð°Ð¿ÐºÑƒ Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ð¼Ð¸
      - ./allure-results:/app/allure-results

  # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ HTTP-ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° (Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð° Allure)
  html-report:
    image: nginx:alpine
    container_name: html-report-server
    depends_on:
      - tests
    ports:
      - "8080:80"
    volumes:
      - ./reports:/usr/share/nginx/html
    command: >
      sh -c "
      # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ favicon.ico, Ñ‡Ñ‚Ð¾Ð±Ñ‹ nginx Ð½Ðµ Ñ€ÑƒÐ³Ð°Ð»ÑÑ
      touch /usr/share/nginx/html/favicon.ico
        
      # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ nginx
      echo 'server {
        listen 80;
        root /usr/share/nginx/html;
          
        location / {
          try_files $$uri /report.html =404;
        }
          
        # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ favicon
        location = /favicon.ico {
          access_log off;
          log_not_found off;
        }
      }' > /etc/nginx/conf.d/default.conf
        
      nginx -g 'daemon off;'
      "