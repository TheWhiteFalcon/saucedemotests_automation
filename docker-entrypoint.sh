#!/bin/bash

echo "?? ????????? Selenium Grid..."
/opt/bin/entry_point.sh &
SELENIUM_PID=$!

echo "? ??????? ?????? Selenium..."
for i in {1..30}; do
    if curl -s http://localhost:4444/wd/hub/status | grep -q "ready"; then
        echo "? Selenium ????? ? ??????!"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "? Selenium ?? ?????????? ?? 30 ??????"
        exit 1
    fi
    echo -n "."
    sleep 1
done

echo "?? ????????? ?????..."
python -m pytest src/tests/ -v --html=report.html
TEST_EXIT_CODE=$?

kill $SELENIUM_PID
wait $SELENIUM_PID

exit $TEST_EXIT_CODE
